<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reservation Page</title>
</head>
<body>
  <header>
    <a href="profile.html">Profile</a>
  </header>
  <h1>Vehicle Reservation</h1>
  <form id="reservationForm">
    <label for="startTime">Start Time:</label>
    <input type="datetime-local" id="startTime" name="startTime" required><br><br>

    <label for="endTime">End Time:</label>
    <input type="datetime-local" id="endTime" name="endTime" required><br><br>

    <button type="submit">Search Vehicles</button>
  </form>

  <div id="vehiclesList">
    <h2>Available Vehicles</h2>
    <ul id="vehicleResults"></ul>
  </div>

  <script>
    // Convert the local time (from the datetime-local input) to the required "YYYY-MM-DD HH:MM:SS" format
    function convertToLocalFormat(dateTimeLocal) {
      const localTime = new Date(dateTimeLocal);  // Create a Date object from the local time

      // Get the individual components of the date and time
      const year = localTime.getFullYear();
      const month = String(localTime.getMonth() + 1).padStart(2, '0');  // Add 1 to month as getMonth() is zero-indexed
      const day = String(localTime.getDate()).padStart(2, '0');
      const hours = String(localTime.getHours()).padStart(2, '0');
      const minutes = String(localTime.getMinutes()).padStart(2, '0');
      const seconds = String(localTime.getSeconds()).padStart(2, '0');

      // Return the formatted string in "YYYY-MM-DD HH:MM:SS" format
      return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
    }

    // Reserve vehicle function
    function reserveVehicle(vehicleId) {
      const startTime = document.getElementById('startTime').value;
      const endTime = document.getElementById('endTime').value;

      if (!startTime || !endTime) {
        alert('Reservation times are missing. Please try again.');
        return;
      }

      // Convert local times to "YYYY-MM-DD HH:MM:SS" format
      const startTimeFormatted = convertToLocalFormat(startTime);
      const endTimeFormatted = convertToLocalFormat(endTime);

      // Redirect to the reservation page with necessary details in the URL
      const url = `reservation.html?vehicleId=${vehicleId}&startTime=${encodeURIComponent(startTimeFormatted)}&endTime=${encodeURIComponent(endTimeFormatted)}`;
      window.location.href = url;
    }

    // Handle the form submission
    document.getElementById('reservationForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      const startTime = document.getElementById('startTime').value;
      const endTime = document.getElementById('endTime').value;

      // Check if both start and end time are provided
      if (!startTime || !endTime) {
        alert('Both start time and end time are required!');
        return;
      }

      // Convert local times to "YYYY-MM-DD HH:MM:SS" format
      const startTimeFormatted = convertToLocalFormat(startTime);
      const endTimeFormatted = convertToLocalFormat(endTime);
      
      if (new Date(startTimeFormatted) > new Date(endTimeFormatted)) {
      alert('Start time cannot be after end time. Please check the dates and try again.');
      return;
    }
      // Fetch available vehicles with the correct payload
      const vehicles = await getAvailableVehicles(startTimeFormatted, endTimeFormatted);
      displayVehicles(vehicles);
    });

    // Get available vehicles from the backend
    function getAvailableVehicles(startTime, endTime) {
      // Create an object to represent the time range in the correct format
      const timeRange = {
        start_time: startTime,
        end_time: endTime
      };

      // Send a POST request with the time range as the JSON body
      return fetch('http://localhost:8081/vehicles/available', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(timeRange) // Send the time range as a JSON body
      })
      .then(response => response.json())  // Parse the JSON response
      .then(vehicles => {
        // Ensure vehicles is an array
        if (Array.isArray(vehicles)) {
          return vehicles;
        } else {
          console.error('Invalid response format:', vehicles);
          return []; // Return an empty array if the response is invalid
        }
      })
      .catch(error => {
        // Handle any errors here
        console.error('Error:', error);
        return []; // Return an empty array in case of error
      });
    }

    // Display the available vehicles
    function displayVehicles(vehicles) {
      const vehicleList = document.getElementById('vehicleResults');
      vehicleList.innerHTML = '';

      if (vehicles.length === 0) {
        vehicleList.innerHTML = '<li>No available vehicles found.</li>';
      } else {
        vehicles.forEach(vehicle => {
          const listItem = document.createElement('li');
          listItem.innerHTML = `
            Vehicle model: ${vehicle.model} - Plate Number: ${vehicle.license_plate} - Cost: $${vehicle.cost}
            <button onclick="reserveVehicle(${vehicle.id})">Reserve</button>
          `;
          vehicleList.appendChild(listItem);
        });
      }
    }
  </script>
</body>
</html>
